<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout Seguro -  Pay</title>

<!-- Meta Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '4179716432354886');
  fbq('track', 'PageView');
</script>
<noscript>
  <img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=4179716432354886&ev=PageView&noscript=1"/>
</noscript>

<!-- Fonte -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#4285F4;   /* Google Blue */
  --brand-dark:#3367d6;
  --bg:#f9f9f9;
  --card:#ffffff;
  --text:#202124;
  --muted:#5f6368;
  --border:#dadce0;
  --danger:#ea4335;
  --success:#34a853;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  font-family:'Roboto',sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0; padding:0;
}

/* Header Timer */
.header-timer{
  position:sticky; top:0; z-index:10;
  background:var(--brand); color:#fff;
  text-align:center; font-weight:700; padding:12px 10px; letter-spacing:.3px;
  text-transform:uppercase; font-size:14px;
}

/* Container / Card */
.container{
  max-width:440px; margin:32px auto; background:var(--card); border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,.08);
  padding:24px; border:1px solid var(--border);
}

.secure{
  display:flex; align-items:center; gap:8px; margin-bottom:8px; font-weight:700; color:var(--success);
}
.secure::before{content:"üîí";}
.country{ text-align:right; font-size:14px; color:var(--muted); margin-top:-22px; margin-bottom:10px;}

.logo{text-align:center; margin-bottom:8px;}
.logo .badge{
  width:64px; height:64px; border-radius:12px;
  display:inline-grid; place-items:center;
  background:var(--brand);
  color:#fff; font-weight:700; font-size:24px;
  box-shadow:0 4px 12px rgba(66,133,244,.4);
}

.title{text-align:center; font-weight:700; margin-top:8px; font-size:20px;}
.price{text-align:center; color:var(--brand); font-size:24px; font-weight:700; margin:10px 0 6px;}
.subprice{text-align:center; color:var(--muted); font-size:12px; margin-bottom:16px}

/* Form */
label{display:block; margin-top:12px; margin-bottom:6px; font-weight:500; color:var(--text);}
input[type="text"], input[type="email"]{
  width:100%; padding:12px; border:1px solid var(--border);
  background:#fff; color:var(--text); border-radius:8px; font-size:14px; outline:none;
  transition:border .2s ease, box-shadow .2s ease;
}
input[type="text"]:focus, input[type="email"]:focus{
  border-color:var(--brand); box-shadow:0 0 0 3px rgba(66,133,244,.15);
}

/* Payment methods */
.payment-methods{
  display:flex; gap:10px; margin-top:10px;
}
.payment-methods button{
  flex:1; padding:12px; border:1px solid var(--border);
  background:#fff; color:var(--text); cursor:pointer; border-radius:8px; font-weight:600;
  transition:all .18s ease;
}
.payment-methods button:hover{background:#f1f3f4}
.payment-methods .active{
  border-color:var(--brand); background:#e8f0fe; color:var(--brand-dark);
}

/* Details */
.details{
  margin-top:18px; background:#f8f9fa; border:1px solid var(--border); padding:14px; border-radius:8px; font-size:14px;
}
.details p{margin:6px 0;}
.details strong{color:var(--text)}

/* Button */
.buy-btn{
  margin-top:18px; background:var(--brand); color:#fff; width:100%; padding:14px; font-size:16px;
  border:none; border-radius:24px; cursor:pointer; font-weight:700;
  transition:background .2s ease, transform .06s ease;
  box-shadow:0 4px 12px rgba(66,133,244,.3);
}
.buy-btn:hover{background:var(--brand-dark)}
.buy-btn:active{transform:scale(.98)}

/* Order Bump */
.order-bump{
  display:flex; align-items:flex-start; gap:10px; margin-top:16px;
  background:#f1f3f4;
  border:1px dashed var(--brand); border-radius:8px; padding:12px; cursor:pointer;
  font-size:14px;
}
.order-bump input{margin-top:3px; width:20px; height:20px; accent-color:var(--brand);}
.order-bump .txt .t{font-weight:600; color:var(--brand);}
  
/* Popup */
#popup{
  display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;
}
#popup .modal{
  background:#fff; padding:24px; border-radius:12px; text-align:center; max-width:320px;
  border:1px solid var(--border); box-shadow:0 6px 20px rgba(0,0,0,.2);
}
#popup h3{margin:0 0 8px 0; color:var(--brand-dark)}
#popup b{color:var(--brand)}
#contador{margin-top:10px; color:var(--muted); font-size:13px;}
</style>
</head>
<body>

<div class="header-timer">Oferta expira em 00:09:56</div>

<div class="container">
  <div class="secure">COMPRA SEGURA</div>
  <div class="country">üá≤üáø</div>

  <div class="img"><div class="badge"></div></div>

  <div class="title">Taxa Anti Fraude </div>
  <div class="price" id="price">300,00 MT</div>
  <div class="subprice">Produto digital ‚Äì entrega via WhatsApp ap√≥s confirma√ß√£o</div>

  <form id="formPagamento">
    <label for="nome">Nome completo</label>
    <input type="text" id="nome" name="nome" placeholder="Seu nome" required  />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" placeholder="seu@email.com" required />

    <label>M√©todo de pagamento</label>
    <div class="payment-methods">
      <button type="button" data-metodo="mpesa" class="active">üì± M-Pesa</button>
      <button type="button" data-metodo="emola">üì≤ e-Mola</button>
    </div>

    <label for="numero">N√∫mero de pagamento</label>
    <input type="text" id="numero" name="telefone" placeholder="8xxxxxxxx" required minlength="9" maxlength="9" />

    <!-- Order Bump -->
    <div class="order-bump" id="orderBump">
      <input type="checkbox" id="bumpCheck">
      <div class="txt"><span class="t">Adicionar Comunidade VIP (+97 MT)</span><br><span style="color:var(--muted)">Acesso a conte√∫dos exclusivos e materiais b√¥nus.</span></div>
    </div>

    <div class="details">
      <p><strong>Detalhes da compra</strong></p>
      <p>Taxa Anti Fraude </p>
      <p><strong>Order Bump:</strong> <span id="bumpLabel">N√£o</span></p>
      <p><strong>Total:</strong> <span id="totalFmt">300,00 MT</span></p>
    </div>

    <button type="submit" class="buy-btn">Comprar agora</button>
  </form>
</div>

<div id="popup">
  <div class="modal">
    <h3>üîê Processando pagamento...</h3>
    <p>Enviando pedido via <b><span id="metodoSelecionado"></span></b>.</p>
    <p>Aguarde a confirma√ß√£o ap√≥s digitar o PIN.</p>
    <p id="contador">Fechando em 180s...</p>
  </div>
</div>

<script>
const metodoBtns = document.querySelectorAll(".payment-methods button");
let metodoSelecionado = "mpesa";
let wallet_id = "";
let number_waht = "258824342006";
let push_cut ="https://api.pushcut.io/QsggCCih4K4SGeZy3F37z/notifications/MinhaNotifica%C3%A7%C3%A3o";
let push_cut_1 ="https://api.pushcut.io/FGIMnjsUNYIAlFJ_OGbP8/notifications/MinhaNotifica%C3%A7%C3%A3o"
let acess_token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI5ZjkwMzg2Mi1hNzgwLTQ0MGQtOGVkNS1iOGQ4MDkwYjE4MGUiLCJqdGkiOiIxNTdmMTM4NDZiNjUwMDUxYzg3ODQ1NDc5ZjQ4NmQwNGU5MDIxMTBmOWNjNDJlNWNlMmQxOTg3ZjQ0Y2MzOThiM2VmYjYyYmI4OWNiYjk5NSIsImlhdCI6MTc1NDg2MzIzMS41MjQ0NDksIm5iZiI6MTc1NDg2MzIzMS41MjQ0NTEsImV4cCI6MTc4NjM5OTIzMS41MjE1MDMsInN1YiI6IiIsInNjb3BlcyI6W119.sSGP5ncLSw-OOp3hW7YQpFtXcXqnheEIAt1G3Nn8-v-ajgtyV8EE9yrbV_rLlTHvMZfs7p-0VNe8yrWXLwWj8CPgyVFzutX918uEdPHODz-osU8ROYWE5-IMrADwuQ8JA1IHQZKXp9jj41bxVhYqcvMmBrH_Tt2tKKa4JHunYlD_xgjWgNLmHArq31J5iyC8_jNR6LWDTqx7ohWX0LIuQ3mXfl8WKFAmx06YzWHWG4kNFLZZzsd1e-UVP_WqmTQ-ptX_nOA3AelV5xFJGM_i__cghWM3TQUX6Wx4JD3YolHyU3C7G7Z6HtFQ-_Jb2JE4kHZGMmu-85NJgcQS6FbVIkI6ZWSoWI_DsjtdkYMo-Sbz4m-9rYPRXVocsz0rSAMeV-BQkm6Vh-ux7a5j677eumdvz6Osdp08BjpkJ25ZHN6wQru0JCjSCiTasfY7BPYxdWi4JWD4Xec4Ssvi1XzD2M7_pQ_QJ0JGaWyU3jez4IpYyFjw7CZO7aWi-SAFZPNuXZ04V0qXqmpVH-2Q5w7O29-zdkEYwvmJfPcokFGzRJpvseXxfxnOSjHuZxOAJ_J8aBXRyswXfz0ID3xqWjzj53wvVOCjowzMBrfMYJeR4u72ODxO2zey0E3Lux7zdTBCbqLB5J45DmACfWmXY1G9--bIbBq4lSTIcqwrkXbV9pM"; // teu token M-Pesa/e-Mola

// =============================
// üîó Captura de UTM
// =============================
function getUTMParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    utm_source: urlParams.get("utm_source") || null,
    utm_medium: urlParams.get("utm_medium") || null,
    utm_campaign: urlParams.get("utm_campaign") || null,
    utm_term: urlParams.get("utm_term") || null,
    utm_content: urlParams.get("utm_content") || null
  };
}
const utmData = getUTMParameters();
localStorage.setItem("utm_data", JSON.stringify(utmData));

// =============================
// üîó Fun√ß√£o Envio Utmify
// =============================
async function sendToUtmify(status, orderId, customer, total, utmData) {
  const exchangeRate = 0.091; // 1 MZN ‚âà 0.091 BRL
  const totalPriceInCentsBRL = Math.max(1, Math.round(total * exchangeRate * 100)); // nunca 0
  const gatewayFee = Math.max(1, Math.round(totalPriceInCentsBRL * 0.05)); // simula√ß√£o 5%
  const userCommission = totalPriceInCentsBRL - gatewayFee;

  const now = new Date();
  const createdAt = now.toISOString().replace("T", " ").substring(0, 19);
  const approvedDate = status === "paid" ? createdAt : null;

  const payload = {
    orderId: String(orderId),
    platform: "SpotifyPay",
    paymentMethod: "pix",
    status: status,
    createdAt: createdAt,
    approvedDate: approvedDate,
    refundedAt: null,
    customer: {
      name: customer.nome,
      email: customer.email,
      phone: customer.phone,
      document: null,
      country: "MZ",
      ip: "127.0.0.1" // Utmify recomenda enviar algo
    },
    products: [
      {
        id: "spotify-anti-fraude",
        name: "Taxa Anti Fraude Spotify",
        planId: null,
        planName: null,
        quantity: 1,
        priceInCents: totalPriceInCentsBRL
      }
    ],
    trackingParameters: {
      src: null,
      sck: null,
      utm_source: utmData.utm_source || null,
      utm_campaign: utmData.utm_campaign || null,
      utm_medium: utmData.utm_medium || null,
      utm_content: utmData.utm_content || null,
      utm_term: utmData.utm_term || null
    },
    commission: {
      totalPriceInCents: totalPriceInCentsBRL,
      gatewayFeeInCents: gatewayFee,
      userCommissionInCents: userCommission,
      currency: "BRL"
    },
    isTest: false
  };

  try {
    const response = await fetch("https://api.utmify.com.br/api-credentials/orders", {
      method: "POST",
      headers: {
        "x-api-token": "fpTt4bfdEyFqx4etWWYIKYadVUHGMIlHqcsZ",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    const res = await response.json();
    console.log("üì© UTMIFY ["+status+"] =>", res);
  } catch (err) {
    console.error("Erro ao enviar para Utmify:", err);
  }
}


// =============================
// L√≥gica Checkout
// =============================
metodoBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    metodoBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    metodoSelecionado = btn.dataset.metodo;
  });
});

const vipCheckbox = document.getElementById("bumpCheck");
const totalFmtEl = document.getElementById("totalFmt");
const bumpLabelEl = document.getElementById("bumpLabel");
const PRICE_BASE = 300;
const PRICE_BUMP = 97;

vipCheckbox.addEventListener("change",()=>{
  const total = PRICE_BASE + (vipCheckbox.checked ? PRICE_BUMP : 0);
  totalFmtEl.textContent = total.toLocaleString('pt-MZ',{style:'currency', currency:'MZN'});
  bumpLabelEl.textContent = vipCheckbox.checked ? "Sim (+97 MT)" : "N√£o";
});

fbq('track','InitiateCheckout');

document.getElementById("formPagamento").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nome = document.getElementById("nome").value;
  const email = document.getElementById("email").value;
  const telefone = document.getElementById("numero").value;
  const total = PRICE_BASE + (vipCheckbox.checked ? PRICE_BUMP : 0);

  if (!nome || !email || !telefone || !metodoSelecionado) throw new Error('Dados incompletos');
  if (!/^(84|85|86|87)\d{7}$/.test(telefone)) throw new Error('Numero de telefone invalido');

  const popup = document.getElementById("popup");
  popup.style.display = "flex";

  // Envia WAITING_PAYMENT para Utmify
  sendToUtmify("waiting_payment", Date.now().toString(), {nome, email, phone: telefone}, total, utmData);

  let tempo = 180;
  const interval = setInterval(() => {
    document.getElementById("contador").innerText = `Fechando em ${tempo--}s...`;
    if (tempo < 0) clearInterval(interval);
  }, 1000);

  wallet_id = metodoSelecionado==='mpesa'?"993607":"993606";

  try {
    const resposta = await fetch(`https://mpesaemolatech.com/v1/c2b/${metodoSelecionado}-payment/${wallet_id}`,{
      method: "POST",
      headers: {
         "Authorization": `Bearer ${acess_token}`,
         "Accept": "application/json",
         "Content-Type": "application/json"
        },
      body: JSON.stringify({
          "client_id": "9f903862-a780-440d-8ed5-b8d8090b180e",
          "amount": total,
          "phone": telefone,
          "reference": "PrimeiroPagamento"
      })
    });
    if(resposta.status===200){
      try{ await fetch(push_cut,{method:'POST',body:JSON.stringify({text:`${nome} pagou ${total} MZN por ${metodoSelecionado}`,title:'Nova venda aprovada'})}); }catch(err){}
      try{ await fetch(push_cut_1,{method:'POST',body:JSON.stringify({text:`${nome} pagou ${total} MZN por ${metodoSelecionado}`,title:'Nova venda aprovada'})}); }catch(err){}
      let mensagem = `Comprei o produto Ferramenta Secreta e quero o receber, meu nome √© ${nome}, paguei usando o ${metodoSelecionado} pelo numero: ${telefone}`;
      let link = `https://wa.me/${number_waht}?text=` + encodeURIComponent(mensagem);
      fbq('track', 'Purchase', {
        value: total,
        currency: 'MZN',
        content_name: 'Ferramenta Secreta',
        content_category: metodoSelecionado
      });

      // Envia PAID para Utmify
      sendToUtmify("paid", Date.now().toString(), {nome, email, phone: telefone}, total, utmData);

      window.location.href = link;
    } else {
      throw new Error("Pagamento n√£o foi processado");
      setTimeout(()=>{window.location.reload()},2000);
    }
  } catch(error){
    throw new Error("Pagamento n√£o foi processado");
    setTimeout(()=>{window.location.reload()},2000);
  }
});
</script>

</body>
</html>
